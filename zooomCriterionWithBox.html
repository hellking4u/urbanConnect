<html>

<body>

  <script src="https://js.leapmotion.com/leap-0.6.4.js"></script>

  <div id="stage" style="background-color:rgb(191,191,191); width:800; height:600">

  </div>
  <div id="debug-box" style="background-color: #f2f2f2;width: 200;height: 200;position: absolute;left: 808;top: 200;">-41,128,201</div>
  <script>
    const debugBox = document.getElementById("debug-box");

    const vPlaneZ = -40;
    var screenZ = -120;
    var interactionBox = [[-45, 240], [40, 310]];
    var calibrationLevel = -1;
    const defInteractionBox = [[-25.5077, 301.73], [30.6594, 249.462]];
    function transformCoordToZoomIndex(tipPos, scaleDelta = 0.5) {

      // check if x and y are close enough
      const x = tipPos[0];
      const y = tipPos[1];
      const z = tipPos[2];

      if (x < interactionBox[0][0] || x > interactionBox[1][0] || y < interactionBox[1][1] || y > interactionBox[0][1])
        return 1;
      if (z > vPlaneZ || z < screenZ)
        return 1;

      return 1 + ((z - vPlaneZ) / (screenZ - vPlaneZ)) * scaleDelta
    }
    // function

    function calibrateBox(tipPos) {
      console.log('start calibration');
      if (calibrationLevel < 1) {
        calibrationLevel = 1;
        console.log('calibration level 1');
        interactionBox[0][0] = tipPos[0];
        interactionBox[0][1] = tipPos[1];
        console.log(interactionBox);
        screenZ = tipPos[2];
        return 0;
      } else if (calibrationLevel === 1) {
        console.log('calibration level 2');
        calibrationLevel = 0;
        interactionBox[1][0] = tipPos[0];
        interactionBox[1][1] = tipPos[1];
        screenZ = tipPos[2];
        console.log(interactionBox);
      }
      console.log(`Calibration Level ${calibrationLevel}`)
    }
    Leap.loop(function (frame) {

      if (frame.hands.length > 0) {
        debugBox.innerHTML = "";
        const finger = frame.hands[0].indexFinger;
        debugBox.innerHTML += finger.tipPosition.map(val => Math.round(val));
        debugBox.innerHTML += '<br />';
        var rect = debugBox.getBoundingClientRect();
        debugBox.innerHTML += `Box pos : ${Math.round(rect.top)}, ${Math.round(rect.right)}, ${Math.round(rect.bottom)}, ${Math.round(rect.left)}`;
        debugBox.innerHTML += '<br />';
        const zoomFactor = transformCoordToZoomIndex(finger.tipPosition);

        debugBox.innerHTML += `zoom factor ${zoomFactor}`;

        if (calibrationLevel === 0) {
          console.log('trying to do stuff');
          debugBox.style.transform = `scale(${zoomFactor},${zoomFactor})`
        }
        document.onkeypress = function (oPEvt) {
          var oEvent = oPEvt || window.event, nChr = oEvent.charCode;
          if (nChr == 99) {
            calibrateBox(finger.tipPosition);
          }
        }
      }

      // console.log(frame.hands[0].fingers);
    });
  </script>
  <link href="/style.css">
</body>

</html>